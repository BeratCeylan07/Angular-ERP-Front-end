import { Directive, Host, Input } from '@angular/core';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { SwalPortalComponent } from './swal-portal.component';
import * as i0 from "@angular/core";
import * as i1 from "./sweetalert2-loader.service";
import * as i2 from "./swal-portal-targets.service";
import * as i3 from "./swal.component";
/**
 * A structural directive that lets you use Angular templates inside of SweetAlerts.
 * There are different targetable zones provided by {@link SwalPortalTargets}: title, content, confirmButton, etc, but
 * you can also make your own target by implementing {@link SwalPortalTarget} and giving it to this directive.
 * The default target is the alert text content zone.
 *
 * Usage in your component's TypeScript (if you use another target than {@link SwalPortalTargets.content}):
 *
 *     @Component({ ... })
 *     export class MyComponent {
 *         public constructor(public readonly swalTargets: SwalPortalTargets) {
 *         }
 *     }
 *
 * Usage in the template:
 *
 *     <swal title="Fill the form" (confirm)="confirmHandler()">
 *         <!-- This form will be displayed as the alert main content
 *              Targets the alert's main content zone by default -->
 *         <form *swalPortal [formControl]="myForm">
 *             ...
 *         </form>
 *
 *         <!-- This targets the confirm button's inner content
 *              Notice the usage of ng-container to avoid creating an useless DOM element inside the button -->
 *         <ng-container *swalPortal="swalTargets.confirmButton">
 *              Send ({{ secondsLeft }} seconds left)
 *         </ng-container>
 *     <swal>
 */
export class SwalPortalDirective {
    resolver;
    injector;
    app;
    templateRef;
    sweetAlert2Loader;
    swalTargets;
    swalComponent;
    /**
     * Takes a portal target or nothing (then it will target the text content zone by default).
     *
     * See the {@link SwalPortalTargets} service to see the available targets.
     * See the class doc block for more informations.
     */
    target;
    /**
     * Holds the component reference of the controlled SwalPortalComponent to destroy it when no longer needed.
     */
    portalComponentRef;
    destroyed = new Subject();
    constructor(resolver, injector, app, templateRef, sweetAlert2Loader, swalTargets, swalComponent) {
        this.resolver = resolver;
        this.injector = injector;
        this.app = app;
        this.templateRef = templateRef;
        this.sweetAlert2Loader = sweetAlert2Loader;
        this.swalTargets = swalTargets;
        this.swalComponent = swalComponent;
    }
    /**
     * Subscribes to the the SweetAlert appearance/disappearance events to create/destroy the SwalPortalComponent
     * that will receive the consumer's template.
     */
    ngOnInit() {
        // Can't be set in a default property value, if the customer lets *swalPortal empty, the value we get is undef.
        this.target = this.target || this.swalTargets.content;
        //=> Apply the options provided by the target definition
        void this.swalComponent.update(this.target.options);
        //=> Subscribe to a few hooks frm the parent SwalComponent.
        this.swalComponent.didRender.pipe(takeUntil(this.destroyed)).subscribe(this.didRenderHook.bind(this));
        this.swalComponent.willOpen.pipe(takeUntil(this.destroyed)).subscribe(this.willOpenHook.bind(this));
        this.swalComponent.didDestroy.pipe(takeUntil(this.destroyed)).subscribe(this.didDestroyHook.bind(this));
    }
    /**
     * Signal any {@link destroyed} consumer that this is over, so they can unsubscribe from the
     * parent SwalComponent events.
     */
    ngOnDestroy() {
        this.destroyed.next();
    }
    /**
     * This didRender hook runs 1..n times (per modal instance), just before the modal is shown (and also before the
     * {@link willOpenHook}), or after Swal.update() is called.
     * This is a good place to render, or re-render, our portal contents.
     */
    async didRenderHook() {
        //=> Ensure the portal component is created
        if (!this.portalComponentRef) {
            this.portalComponentRef = this.createPortalComponent();
        }
        //=> SweetAlert2 created the modal or just erased all of our content, so we need to install/reinstall it.
        // Swal.update() is synchronous, this observable too, and mountComponentOnTarget too (the promise inside
        // this function is already resolved at this point), so the whole process of re-rendering and re-mounting
        // the portal component is fully synchronous, causing no blinks in the modal contents.
        const swal = await this.sweetAlert2Loader.swal;
        //=> Find target element
        const targetEl = this.target.element(swal);
        if (!targetEl)
            return;
        //=> Replace target's contents with our component
        // https://jsperf.com/innerhtml-vs-removechild/15
        while (targetEl.firstChild) {
            targetEl.removeChild(targetEl.firstChild);
        }
        targetEl.appendChild(this.portalComponentRef.location.nativeElement);
    }
    /**
     * This willOpen hook runs once (per modal instance), just before the modal is shown on the screen.
     * This is a good place to declare our detached view to the Angular app.
     */
    willOpenHook() {
        if (!this.portalComponentRef)
            return;
        //=> Make the Angular app aware of that detached view so rendering and change detection can happen
        this.app.attachView(this.portalComponentRef.hostView);
    }
    /**
     * This didDestroy hook runs once (per modal instance), just after the modal closing animation terminated.
     * This is a good place to detach and destroy our content, that is not visible anymore.
     */
    didDestroyHook() {
        if (!this.portalComponentRef)
            return;
        //=> Detach the portal component from the app and destroy it
        this.app.detachView(this.portalComponentRef.hostView);
        this.portalComponentRef.destroy();
        this.portalComponentRef = void 0;
    }
    /**
     * Creates the {@link SwalPortalComponent} and gives it the customer's template ref.
     */
    createPortalComponent() {
        //=> Create the SwalPortalComponent that will hold our content
        const factory = this.resolver.resolveComponentFactory(SwalPortalComponent);
        // Yes, we do not use the third argument that would directly use the target as the component's view
        // (unfortunately, because that would give a cleaner DOM and would avoid dirty and direct DOM manipulations)
        // That's because we want to keep our component safe from SweetAlert2's operations on the DOM, and to be
        // able to restore it at any moment, ie. after the modal has been re-rendered.
        const componentRef = factory.create(this.injector, []);
        //=> Apply the consumer's template on the component
        componentRef.instance.template = this.templateRef;
        return componentRef;
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.5", ngImport: i0, type: SwalPortalDirective, deps: [{ token: i0.ComponentFactoryResolver }, { token: i0.Injector }, { token: i0.ApplicationRef }, { token: i0.TemplateRef }, { token: i1.SweetAlert2LoaderService }, { token: i2.SwalPortalTargets }, { token: i3.SwalComponent, host: true }], target: i0.ɵɵFactoryTarget.Directive });
    static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.0.5", type: SwalPortalDirective, selector: "[swalPortal]", inputs: { target: ["swalPortal", "target"] }, ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.5", ngImport: i0, type: SwalPortalDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[swalPortal]'
                }]
        }], ctorParameters: function () { return [{ type: i0.ComponentFactoryResolver }, { type: i0.Injector }, { type: i0.ApplicationRef }, { type: i0.TemplateRef }, { type: i1.SweetAlert2LoaderService }, { type: i2.SwalPortalTargets }, { type: i3.SwalComponent, decorators: [{
                    type: Host
                }] }]; }, propDecorators: { target: [{
                type: Input,
                args: ['swalPortal']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3dhbC1wb3J0YWwuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXN3ZWV0YWxlcnQyL3NyYy9saWIvc3dhbC1wb3J0YWwuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDcUQsU0FBUyxFQUFFLElBQUksRUFBWSxLQUFLLEVBRTNGLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7OztBQUk5RDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E2Qkc7QUFJSCxNQUFNLE9BQU8sbUJBQW1CO0lBa0JQO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNRO0lBdkI3Qjs7Ozs7T0FLRztJQUVJLE1BQU0sQ0FBb0I7SUFFakM7O09BRUc7SUFDSyxrQkFBa0IsQ0FBcUM7SUFFOUMsU0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFFakQsWUFDcUIsUUFBa0MsRUFDbEMsUUFBa0IsRUFDbEIsR0FBbUIsRUFDbkIsV0FBNkIsRUFDN0IsaUJBQTJDLEVBQzNDLFdBQThCLEVBQ3RCLGFBQTRCO1FBTnBDLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsUUFBRyxHQUFILEdBQUcsQ0FBZ0I7UUFDbkIsZ0JBQVcsR0FBWCxXQUFXLENBQWtCO1FBQzdCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7UUFDM0MsZ0JBQVcsR0FBWCxXQUFXLENBQW1CO1FBQ3RCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO0lBQ3pELENBQUM7SUFFRDs7O09BR0c7SUFDSSxRQUFRO1FBQ1gsK0dBQStHO1FBQy9HLElB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LHdHQUF3RztRQUN4Ryw4RUFBOEU7UUFDOUUsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXZELG1EQUFtRDtRQUNuRCxZQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBRWxELE9BQU8sWUFBWSxDQUFDO0lBQ3hCLENBQUM7dUdBM0hRLG1CQUFtQjsyRkFBbkIsbUJBQW1COzsyRkFBbkIsbUJBQW1CO2tCQUgvQixTQUFTO21CQUFDO29CQUNQLFFBQVEsRUFBRSxjQUFjO2lCQUMzQjs7MEJBeUJRLElBQUk7NENBaEJGLE1BQU07c0JBRFosS0FBSzt1QkFBQyxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIERpcmVjdGl2ZSwgSG9zdCwgSW5qZWN0b3IsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCxcbiAgICBUZW1wbGF0ZVJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN3YWxQb3J0YWxUYXJnZXQsIFN3YWxQb3J0YWxUYXJnZXRzIH0gZnJvbSAnLi9zd2FsLXBvcnRhbC10YXJnZXRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3dhbFBvcnRhbENvbXBvbmVudCB9IGZyb20gJy4vc3dhbC1wb3J0YWwuY29tcG9uZW50JztcbmltcG9ydCB7IFN3YWxDb21wb25lbnQgfSBmcm9tICcuL3N3YWwuY29tcG9uZW50JztcbmltcG9ydCB7IFN3ZWV0QWxlcnQyTG9hZGVyU2VydmljZSB9IGZyb20gJy4vc3dlZXRhbGVydDItbG9hZGVyLnNlcnZpY2UnO1xuXG4vKipcbiAqIEEgc3RydWN0dXJhbCBkaXJlY3RpdmUgdGhhdCBsZXRzIHlvdSB1c2UgQW5ndWxhciB0ZW1wbGF0ZXMgaW5zaWRlIG9mIFN3ZWV0QWxlcnRzLlxuICogVGhlcmUgYXJlIGRpZmZlcmVudCB0YXJnZXRhYmxlIHpvbmVzIHByb3ZpZGVkIGJ5IHtAbGluayBTd2FsUG9ydGFsVGFyZ2V0c306IHRpdGxlLCBjb250ZW50LCBjb25maXJtQnV0dG9uLCBldGMsIGJ1dFxuICogeW91IGNhbiBhbHNvIG1ha2UgeW91ciBvd24gdGFyZ2V0IGJ5IGltcGxlbWVudGluZyB7QGxpbmsgU3dhbFBvcnRhbFRhcmdldH0gYW5kIGdpdmluZyBpdCB0byB0aGlzIGRpcmVjdGl2ZS5cbiAqIFRoZSBkZWZhdWx0IHRhcmdldCBpcyB0aGUgYWxlcnQgdGV4dCBjb250ZW50IHpvbmUuXG4gKlxuICogVXNhZ2UgaW4geW91ciBjb21wb25lbnQncyBUeXBlU2NyaXB0IChpZiB5b3UgdXNlIGFub3RoZXIgdGFyZ2V0IHRoYW4ge0BsaW5rIFN3YWxQb3J0YWxUYXJnZXRzLmNvbnRlbnR9KTpcbiAqXG4gKiAgICAgQENvbXBvbmVudCh7IC4uLiB9KVxuICogICAgIGV4cG9ydCBjbGFzcyBNeUNvbXBvbmVudCB7XG4gKiAgICAgICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgc3dhbFRhcmdldHM6IFN3YWxQb3J0YWxUYXJnZXRzKSB7XG4gKiAgICAgICAgIH1cbiAqICAgICB9XG4gKlxuICogVXNhZ2UgaW4gdGhlIHRlbXBsYXRlOlxuICpcbiAqICAgICA8c3dhbCB0aXRsZT1cIkZpbGwgdGhlIGZvcm1cIiAoY29uZmlybSk9XCJjb25maXJtSGFuZGxlcigpXCI+XG4gKiAgICAgICAgIDwhLS0gVGhpcyBmb3JtIHdpbGwgYmUgZGlzcGxheWVkIGFzIHRoZSBhbGVydCBtYWluIGNvbnRlbnRcbiAqICAgICAgICAgICAgICBUYXJnZXRzIHRoZSBhbGVydCdzIG1haW4gY29udGVudCB6b25lIGJ5IGRlZmF1bHQgLS0+XG4gKiAgICAgICAgIDxmb3JtICpzd2FsUG9ydGFsIFtmb3JtQ29udHJvbF09XCJteUZvcm1cIj5cbiAqICAgICAgICAgICAgIC4uLlxuICogICAgICAgICA8L2Zvcm0+XG4gKlxuICogICAgICAgICA8IS0tIFRoaXMgdGFyZ2V0cyB0aGUgY29uZmlybSBidXR0b24ncyBpbm5lciBjb250ZW50XG4gKiAgICAgICAgICAgICAgTm90aWNlIHRoZSB1c2FnZSBvZiBuZy1jb250YWluZXIgdG8gYXZvaWQgY3JlYXRpbmcgYW4gdXNlbGVzcyBET00gZWxlbWVudCBpbnNpZGUgdGhlIGJ1dHRvbiAtLT5cbiAqICAgICAgICAgPG5nLWNvbnRhaW5lciAqc3dhbFBvcnRhbD1cInN3YWxUYXJnZXRzLmNvbmZpcm1CdXR0b25cIj5cbiAqICAgICAgICAgICAgICBTZW5kICh7eyBzZWNvbmRzTGVmdCB9fSBzZWNvbmRzIGxlZnQpXG4gKiAgICAgICAgIDwvbmctY29udGFpbmVyPlxuICogICAgIDxzd2FsPlxuICovXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1tzd2FsUG9ydGFsXSdcbn0pXG5leHBvcnQgY2xhc3MgU3dhbFBvcnRhbERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgICAvKipcbiAgICAgKiBUYWtlcyBhIHBvcnRhbCB0YXJnZXQgb3Igbm90aGluZyAodGhlbiBpdCB3aWxsIHRhcmdldCB0aGUgdGV4dCBjb250ZW50IHpvbmUgYnkgZGVmYXVsdCkuXG4gICAgICpcbiAgICAgKiBTZWUgdGhlIHtAbGluayBTd2FsUG9ydGFsVGFyZ2V0c30gc2VydmljZSB0byBzZWUgdGhlIGF2YWlsYWJsZSB0YXJnZXRzLlxuICAgICAqIFNlZSB0aGUgY2xhc3MgZG9jIGJsb2NrIGZvciBtb3JlIGluZm9ybWF0aW9ucy5cbiAgICAgKi9cbiAgICBASW5wdXQoJ3N3YWxQb3J0YWwnKVxuICAgIHB1YmxpYyB0YXJnZXQ/OiBTd2FsUG9ydGFsVGFyZ2V0O1xuXG4gICAgLyoqXG4gICAgICogSG9sZHMgdGhlIGNvbXBvbmVudCByZWZlcmVuY2Ugb2YgdGhlIGNvbnRyb2xsZWQgU3dhbFBvcnRhbENvbXBvbmVudCB0byBkZXN0cm95IGl0IHdoZW4gbm8gbG9uZ2VyIG5lZWRlZC5cbiAgICAgKi9cbiAgICBwcml2YXRlIHBvcnRhbENvbXBvbmVudFJlZj86IENvbXBvbmVudFJlZjxTd2FsUG9ydGFsQ29tcG9uZW50PjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveWVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGluamVjdG9yOiBJbmplY3RvcixcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uUmVmLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxhbnk+LFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHN3ZWV0QWxlcnQyTG9hZGVyOiBTd2VldEFsZXJ0MkxvYWRlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgc3dhbFRhcmdldHM6IFN3YWxQb3J0YWxUYXJnZXRzLFxuICAgICAgICBASG9zdCgpIHByaXZhdGUgcmVhZG9ubHkgc3dhbENvbXBvbmVudDogU3dhbENvbXBvbmVudCkge1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXMgdG8gdGhlIHRoZSBTd2VldEFsZXJ0IGFwcGVhcmFuY2UvZGlzYXBwZWFyYW5jZSBldmVudHMgdG8gY3JlYXRlL2Rlc3Ryb3kgdGhlIFN3YWxQb3J0YWxDb21wb25lbnRcbiAgICAgKiB0aGF0IHdpbGwgcmVjZWl2ZSB0aGUgY29uc3VtZXIncyB0ZW1wbGF0ZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgICAgIC8vIENhbid0IGJlIHNldCBpbiBhIGRlZmF1bHQgcHJvcGVydHkgdmFsdWUsIGlmIHRoZSBjdXN0b21lciBsZXRzICpzd2FsUG9ydGFsIGVtcHR5LCB0aGUgdmFsdWUgd2UgZ2V0IGlzIHVuZGVmLlxuICAgICAgICB0aGlzLnRhcmdldCA9IHRoaXMudGFyZ2V0IHx8IHRoaXMuc3dhbFRhcmdldHMuY29udGVudDtcblxuICAgICAgICAvLz0+IEFwcGx5IHRoZSBvcHRpb25zIHByb3ZpZGVkIGJ5IHRoZSB0YXJnZXQgZGVmaW5pdGlvblxuICAgICAgICB2b2lkIHRoaXMuc3dhbENvbXBvbmVudC51cGRhdGUodGhpcy50YXJnZXQub3B0aW9ucyk7XG5cbiAgICAgICAgLy89PiBTdWJzY3JpYmUgdG8gYSBmZXcgaG9va3MgZnJtIHRoZSBwYXJlbnQgU3dhbENvbXBvbmVudC5cbiAgICAgICAgdGhpcy5zd2FsQ29tcG9uZW50LmRpZFJlbmRlci5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZSh0aGlzLmRpZFJlbmRlckhvb2suYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMuc3dhbENvbXBvbmVudC53aWxsT3Blbi5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZSh0aGlzLndpbGxPcGVuSG9vay5iaW5kKHRoaXMpKTtcbiAgICAgICAgdGhpcy5zd2FsQ29tcG9uZW50LmRpZERlc3Ryb3kucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpKS5zdWJzY3JpYmUodGhpcy5kaWREZXN0cm95SG9vay5iaW5kKHRoaXMpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTaWduYWwgYW55IHtAbGluayBkZXN0cm95ZWR9IGNvbnN1bWVyIHRoYXQgdGhpcyBpcyBvdmVyLCBzbyB0aGV5IGNhbiB1bnN1YnNjcmliZSBmcm9tIHRoZVxuICAgICAqIHBhcmVudCBTd2FsQ29tcG9uZW50IGV2ZW50cy5cbiAgICAgKi9cbiAgICBwdWJsaWMgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGVzdHJveWVkLm5leHQoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGRpZFJlbmRlciBob29rIHJ1bnMgMS4ubiB0aW1lcyAocGVyIG1vZGFsIGluc3RhbmNlKSwganVzdCBiZWZvcmUgdGhlIG1vZGFsIGlzIHNob3duIChhbmQgYWxzbyBiZWZvcmUgdGhlXG4gICAgICoge0BsaW5rIHdpbGxPcGVuSG9va30pLCBvciBhZnRlciBTd2FsLnVwZGF0ZSgpIGlzIGNhbGxlZC5cbiAgICAgKiBUaGlzIGlzIGEgZ29vZCBwbGFjZSB0byByZW5kZXIsIG9yIHJlLXJlbmRlciwgb3VyIHBvcnRhbCBjb250ZW50cy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIGRpZFJlbmRlckhvb2soKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vPT4gRW5zdXJlIHRoZSBwb3J0YWwgY29tcG9uZW50IGlzIGNyZWF0ZWRcbiAgICAgICAgaWYgKCF0aGlzLnBvcnRhbENvbXBvbmVudFJlZikge1xuICAgICAgICAgICAgdGhpcy5wb3J0YWxDb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZVBvcnRhbENvbXBvbmVudCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy89PiBTd2VldEFsZXJ0MiBjcmVhdGVkIHRoZSBtb2RhbCBvciBqdXN0IGVyYXNlZCBhbGwgb2Ygb3VyIGNvbnRlbnQsIHNvIHdlIG5lZWQgdG8gaW5zdGFsbC9yZWluc3RhbGwgaXQuXG4gICAgICAgIC8vIFN3YWwudXBkYXRlKCkgaXMgc3luY2hyb25vdXMsIHRoaXMgb2JzZXJ2YWJsZSB0b28sIGFuZCBtb3VudENvbXBvbmVudE9uVGFyZ2V0IHRvbyAodGhlIHByb21pc2UgaW5zaWRlXG4gICAgICAgIC8vIHRoaXMgZnVuY3Rpb24gaXMgYWxyZWFkeSByZXNvbHZlZCBhdCB0aGlzIHBvaW50KSwgc28gdGhlIHdob2xlIHByb2Nlc3Mgb2YgcmUtcmVuZGVyaW5nIGFuZCByZS1tb3VudGluZ1xuICAgICAgICAvLyB0aGUgcG9ydGFsIGNvbXBvbmVudCBpcyBmdWxseSBzeW5jaHJvbm91cywgY2F1c2luZyBubyBibGlua3MgaW4gdGhlIG1vZGFsIGNvbnRlbnRzLlxuICAgICAgICBjb25zdCBzd2FsID0gYXdhaXQgdGhpcy5zd2VldEFsZXJ0MkxvYWRlci5zd2FsO1xuXG4gICAgICAgIC8vPT4gRmluZCB0YXJnZXQgZWxlbWVudFxuICAgICAgICBjb25zdCB0YXJnZXRFbCA9IHRoaXMudGFyZ2V0IS5lbGVtZW50KHN3YWwpO1xuICAgICAgICBpZiAoIXRhcmdldEVsKSByZXR1cm47XG5cbiAgICAgICAgLy89PiBSZXBsYWNlIHRhcmdldCdzIGNvbnRlbnRzIHdpdGggb3VyIGNvbXBvbmVudFxuICAgICAgICAvLyBodHRwczovL2pzcGVyZi5jb20vaW5uZXJodG1sLXZzLXJlbW92ZWNoaWxkLzE1XG4gICAgICAgIHdoaWxlICh0YXJnZXRFbC5maXJzdENoaWxkKSB7XG4gICAgICAgICAgICB0YXJnZXRFbC5yZW1vdmVDaGlsZCh0YXJnZXRFbC5maXJzdENoaWxkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRhcmdldEVsLmFwcGVuZENoaWxkKHRoaXMucG9ydGFsQ29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgd2lsbE9wZW4gaG9vayBydW5zIG9uY2UgKHBlciBtb2RhbCBpbnN0YW5jZSksIGp1c3QgYmVmb3JlIHRoZSBtb2RhbCBpcyBzaG93biBvbiB0aGUgc2NyZWVuLlxuICAgICAqIFRoaXMgaXMgYSBnb29kIHBsYWNlIHRvIGRlY2xhcmUgb3VyIGRldGFjaGVkIHZpZXcgdG8gdGhlIEFuZ3VsYXIgYXBwLlxuICAgICAqL1xuICAgIHByaXZhdGUgd2lsbE9wZW5Ib29rKCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMucG9ydGFsQ29tcG9uZW50UmVmKSByZXR1cm47XG5cbiAgICAgICAgLy89PiBNYWtlIHRoZSBBbmd1bGFyIGFwcCBhd2FyZSBvZiB0aGF0IGRldGFjaGVkIHZpZXcgc28gcmVuZGVyaW5nIGFuZCBjaGFuZ2UgZGV0ZWN0aW9uIGNhbiBoYXBwZW5cbiAgICAgICAgdGhpcy5hcHAuYXR0YWNoVmlldyh0aGlzLnBvcnRhbENvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBkaWREZXN0cm95IGhvb2sgcnVucyBvbmNlIChwZXIgbW9kYWwgaW5zdGFuY2UpLCBqdXN0IGFmdGVyIHRoZSBtb2RhbCBjbG9zaW5nIGFuaW1hdGlvbiB0ZXJtaW5hdGVkLlxuICAgICAqIFRoaXMgaXMgYSBnb29kIHBsYWNlIHRvIGRldGFjaCBhbmQgZGVzdHJveSBvdXIgY29udGVudCwgdGhhdCBpcyBub3QgdmlzaWJsZSBhbnltb3JlLlxuICAgICAqL1xuICAgIHByaXZhdGUgZGlkRGVzdHJveUhvb2soKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5wb3J0YWxDb21wb25lbnRSZWYpIHJldHVybjtcblxuICAgICAgICAvLz0+IERldGFjaCB0aGUgcG9ydGFsIGNvbXBvbmVudCBmcm9tIHRoZSBhcHAgYW5kIGRlc3Ryb3kgaXRcbiAgICAgICAgdGhpcy5hcHAuZGV0YWNoVmlldyh0aGlzLnBvcnRhbENvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG4gICAgICAgIHRoaXMucG9ydGFsQ29tcG9uZW50UmVmLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5wb3J0YWxDb21wb25lbnRSZWYgPSB2b2lkIDA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyB0aGUge0BsaW5rIFN3YWxQb3J0YWxDb21wb25lbnR9IGFuZCBnaXZlcyBpdCB0aGUgY3VzdG9tZXIncyB0ZW1wbGF0ZSByZWYuXG4gICAgICovXG4gICAgcHJpdmF0ZSBjcmVhdGVQb3J0YWxDb21wb25lbnQoKTogQ29tcG9uZW50UmVmPFN3YWxQb3J0YWxDb21wb25lbnQ+IHtcbiAgICAgICAgLy89PiBDcmVhdGUgdGhlIFN3YWxQb3J0YWxDb21wb25lbnQgdGhhdCB3aWxsIGhvbGQgb3VyIGNvbnRlbnRcbiAgICAgICAgY29uc3QgZmFjdG9yeSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoU3dhbFBvcnRhbENvbXBvbmVudCk7XG5cbiAgICAgICAgLy8gWWVzLCB3ZSBkbyBub3QgdXNlIHRoZSB0aGlyZCBhcmd1bWVudCB0aGF0IHdvdWxkIGRpcmVjdGx5IHVzZSB0aGUgdGFyZ2V0IGFzIHRoZSBjb21wb25lbnQncyB2aWV3XG4gICAgICAgIC8vICh1bmZvcnR1bmF0ZWx5LCBiZWNhdXNlIHRoYXQgd291bGQgZ2l2ZSBhIGNsZWFuZXIgRE9NIGFuZCB3b3VsZCBhdm9pZCBkaXJ0eSBhbmQgZGlyZWN0IERPTSBtYW5pcHVsYXRpb25zKVxuICAgICAgICAvLyBUaGF0J3MgYmVjYXVzZSB3ZSB3YW50IHRvIGtlZXAgb3VyIGNvbXBvbmVudCBzYWZlIGZyb20gU3dlZXRBbGVydDIncyBvcGVyYXRpb25zIG9uIHRoZSBET00sIGFuZCB0byBiZVxuICAgICAgICAvLyBhYmxlIHRvIHJlc3RvcmUgaXQgYXQgYW55IG1vbWVudCwgaWUuIGFmdGVyIHRoZSBtb2RhbCBoYXMgYmVlbiByZS1yZW5kZXJlZC5cbiAgICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gZmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3RvciwgW10pO1xuXG4gICAgICAgIC8vPT4gQXBwbHkgdGhlIGNvbnN1bWVyJ3MgdGVtcGxhdGUgb24gdGhlIGNvbXBvbmVudFxuICAgICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2UudGVtcGxhdGUgPSB0aGlzLnRlbXBsYXRlUmVmO1xuXG4gICAgICAgIHJldHVybiBjb21wb25lbnRSZWY7XG4gICAgfVxufVxuIl19